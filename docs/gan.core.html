---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/09_gan.core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/09_gan.core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">RMSProp</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.model</span> <span class="kn">import</span> <span class="n">TabularModel</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># from data.synthetic_wind_data import get_synthetic_wind_data</span>
<span class="c1"># from utils_plots import data_to_plot, plot_hists, wind_vs_power</span>
<span class="kn">from</span> <span class="nn">fastai.callback.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># from gan import GANLearner</span>
<span class="kn">from</span> <span class="nn">fastai.vision.gan</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">rng_seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="n">TabularDataLoaders</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="n">TabularProc</span><span class="p">,</span> <span class="n">Tabular</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NormalizePerTask</span><span class="p">(</span><span class="n">TabularProc</span><span class="p">):</span>
    <span class="s2">&quot;Normalize per TaskId&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols_to_ignore</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="n">cols_to_ignore</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">Tabular</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to</span><span class="o">.</span><span class="n">cont_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols_to_ignore</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">to</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">to</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span>

    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>

        
<span class="k">def</span> <span class="nf">get_synthetic_wind_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;powerdata&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">drop_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestFlag&quot;</span><span class="p">]</span>
    <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_list</span><span class="p">]</span>
    <span class="c1"># cont_names = [</span>
    <span class="c1">#     &quot;WindSpeed58m&quot;,</span>
    <span class="c1">#     &quot;WindSpeed60m&quot;,</span>
    <span class="c1">#     &quot;PowerGeneration&quot;,</span>
    <span class="c1"># ]</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;T_HAG_2_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RELHUM_HAG_2_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ASWDIFDS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ASWDIRS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WindSpeed58m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WindSpeed60m&quot;</span><span class="p">,</span>
<span class="c1">#         &quot;PowerGeneration&quot;,</span>
    <span class="p">]</span>
    <span class="n">y_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PowerGeneration&quot;</span><span class="p">]</span>
    <span class="c1"># y_names = []</span>

    <span class="n">all_names</span> <span class="o">=</span> <span class="n">cont_names</span> <span class="o">+</span> <span class="n">y_names</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span>
        <span class="n">cont_names</span><span class="o">=</span><span class="n">all_names</span><span class="p">,</span>
        <span class="n">y_names</span><span class="o">=</span><span class="n">all_names</span><span class="p">,</span>
        <span class="c1"># procs=[Normalize],</span>
        <span class="n">bs</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
        <span class="n">procs</span><span class="o">=</span><span class="p">[</span><span class="n">NormalizePerTask</span><span class="p">(</span><span class="n">cols_to_ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PowerGeneration&quot;</span><span class="p">])],</span>
<span class="c1">#         procs=[NormalizePerTask()],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">dls</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/home/scribbler/data/DAF_ICON_Synthetic_Wind_Power_processed/&quot;</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;00011.h5&quot;</span><span class="p">,</span><span class="s2">&quot;01303.h5&quot;</span><span class="p">,</span><span class="s2">&quot;02559.h5&quot;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ls</span> <span class="p">{</span><span class="n">data_path</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>00011.h5  01303.h5  02559.h5  03651.h5  05347.h5  06344.h5
00090.h5  01346.h5  02564.h5  03668.h5  05349.h5  07341.h5
00161.h5  01357.h5  02573.h5  03730.h5  05371.h5  07351.h5
00164.h5  01358.h5  02597.h5  03761.h5  05397.h5  07367.h5
00183.h5  01379.h5  02601.h5  03811.h5  05404.h5  07368.h5
00197.h5  01420.h5  02638.h5  03821.h5  05412.h5  07369.h5
00198.h5  01443.h5  02667.h5  03897.h5  05426.h5  07370.h5
00232.h5  01468.h5  02712.h5  03925.h5  05440.h5  07374.h5
00282.h5  01490.h5  02794.h5  03946.h5  05480.h5  07389.h5
00298.h5  01503.h5  02812.h5  03987.h5  05490.h5  07391.h5
00303.h5  01544.h5  02856.h5  04024.h5  05516.h5  07392.h5
00342.h5  01550.h5  02878.h5  04032.h5  05538.h5  07393.h5
00427.h5  01580.h5  02897.h5  04036.h5  05546.h5  07394.h5
00430.h5  01587.h5  02907.h5  04039.h5  05629.h5  07395.h5
00433.h5  01605.h5  02925.h5  04094.h5  05705.h5  07396.h5
00460.h5  01612.h5  02928.h5  04104.h5  05779.h5  07403.h5
00591.h5  01639.h5  02932.h5  04177.h5  05792.h5  07410.h5
00596.h5  01684.h5  02961.h5  04271.h5  05797.h5  07412.h5
00603.h5  01691.h5  02985.h5  04279.h5  05800.h5  07416.h5
00619.h5  01694.h5  03015.h5  04280.h5  05825.h5  10510.h5
00642.h5  01757.h5  03023.h5  04336.h5  05839.h5  13674.h5
00656.h5  01759.h5  03028.h5  04371.h5  05851.h5  13676.h5
00662.h5  01766.h5  03032.h5  04393.h5  05856.h5  13693.h5
00691.h5  01803.h5  03086.h5  04464.h5  05871.h5  13701.h5
00701.h5  01832.h5  03093.h5  04466.h5  05877.h5  13711.h5
00704.h5  01869.h5  03098.h5  04501.h5  05906.h5  13901.h5
00722.h5  01886.h5  03126.h5  04625.h5  05930.h5  13932.h5
00788.h5  01963.h5  03158.h5  04642.h5  06091.h5  13952.h5
00840.h5  01975.h5  03166.h5  04745.h5  06096.h5  13965.h5
00853.h5  01993.h5  03167.h5  04880.h5  06097.h5  15000.h5
00856.h5  02014.h5  03196.h5  04887.h5  06099.h5  15044.h5
00867.h5  02023.h5  03231.h5  04911.h5  06101.h5  15120.h5
00880.h5  02044.h5  03244.h5  04919.h5  06102.h5  15122.h5
00891.h5  02100.h5  03268.h5  04928.h5  06103.h5  15189.h5
00953.h5  02171.h5  03287.h5  04931.h5  06106.h5  15190.h5
00963.h5  02252.h5  03321.h5  04947.h5  06107.h5  15200.h5
01001.h5  02261.h5  03362.h5  05029.h5  06108.h5  15207.h5
01011.h5  02290.h5  03366.h5  05078.h5  06159.h5  15214.h5
01013.h5  02349.h5  03376.h5  05100.h5  06163.h5  15444.h5
01048.h5  02377.h5  03379.h5  05109.h5  06196.h5  15520.h5
01078.h5  02429.h5  03402.h5  05142.h5  06197.h5  15547.h5
01200.h5  02483.h5  03513.h5  05158.h5  06211.h5  <span class="ansi-magenta-intense-fg ansi-bold">scatter_sample.png</span>
01262.h5  02485.h5  03534.h5  05319.h5  06253.h5  <span class="ansi-magenta-intense-fg ansi-bold">timesersies_sample.png</span>
01270.h5  02497.h5  03631.h5  05327.h5  06314.h5
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="c1"># &quot;n_features&quot;: 24,</span>
<span class="c1">#     &quot;n_targets&quot;: 1,</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">&quot;n_noise_samples&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="mf">1e-5</span><span class="p">,</span>
    <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span> <span class="o">**</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">get_synthetic_wind_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">config</span><span class="p">[</span><span class="s2">&quot;n_features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">cont_names</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([1024, 8])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">==</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.core</span> <span class="kn">import</span> <span class="n">Callback</span><span class="p">,</span> <span class="n">TrainEvalCallback</span>
<span class="kn">from</span> <span class="nn">fastai.callback.progress</span> <span class="kn">import</span> <span class="n">CSVLogger</span>
<span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span><span class="p">,</span> <span class="n">Metric</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">class2attr</span>
<span class="kn">from</span> <span class="nn">fastcore.foundation</span> <span class="kn">import</span> <span class="n">L</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">fastrenewables.tabular.model</span> <span class="kn">import</span> <span class="n">MultiLayerPerceptron</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Tanh</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Sigmoid</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TrainMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">DISC_REAL</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">DISC_FAKE</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">GEN</span><span class="o">=</span><span class="mi">2</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;TrainMode.DISC_REAL: 0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TabularGANModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">critic</span><span class="p">,</span> <span class="n">noise_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TabularGANModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">critic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_size</span> <span class="o">=</span> <span class="n">noise_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_mode</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># for forward-fct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># for optimizer handling</span>

    <span class="k">def</span> <span class="nf">_input_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="p">):</span>
        <span class="c1"># generate random values, used as input for generator</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_size</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">x_cont</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_noise</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">gen_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gen_data</span>

    <span class="k">def</span> <span class="nf">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">freeze</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="n">freeze</span>
            
    <span class="k">def</span> <span class="nf">update_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="n">train_mode</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
        <span class="c1"># TODO: should not be in the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">,</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="c1"># take real data</span>
            <span class="n">crit_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">,</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">):</span>
            <span class="c1"># take synthetic data</span>
            <span class="n">gen_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">)</span>
            <span class="n">crit_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">gen_data</span><span class="p">)</span>
            
<span class="c1">#         print(&quot;crit_out&quot;, crit_out.shape, crit_out[0,0])</span>

        <span class="k">return</span> <span class="n">crit_out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RealLossMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_loss</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">real_loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">real_loss</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class2attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Metric&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FakeLossMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_loss</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">fake_loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_loss</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class2attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Metric&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()</span>
<span class="n">a</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>BCELoss()</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">GANLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GANLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_label</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train_mode</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># change t w.r.t train_mode</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda:0&quot;</span>
        <span class="n">b_size</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_size</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
<span class="c1">#         print(y.shape, y[0,0])</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
<span class="c1">#         print(t.shape, t[0,0])</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.core</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">GANTrainer</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">run_after</span> <span class="o">=</span> <span class="n">TrainEvalCallback</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_gen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_crit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GANTrainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gen</span> <span class="o">=</span> <span class="n">n_gen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_crit</span> <span class="o">=</span> <span class="n">n_crit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span>
        

    <span class="k">def</span> <span class="nf">after_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">crit_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="c1">#         self.c_gen = 0</span>
<span class="c1">#         self.c_crit = 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">crit_opt</span>
        <span class="c1"># zero grad only after DISC_FAKE? is done in _do_one_batch anyways</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_value_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_set_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="n">new_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># TODO: IS THIS DIRECTLY ACCESSING THE MODELS PARAMS?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">fake_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">real_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
            


    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">GANLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dls</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="n">critic</span><span class="p">,</span>
        <span class="n">criterion</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
        <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">noise_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">CSVLogger</span><span class="p">()],</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">RealLossMetric</span><span class="p">,</span> <span class="n">FakeLossMetric</span><span class="p">],</span>
        <span class="n">opt_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">n_gen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_crit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">gan_model</span> <span class="o">=</span> <span class="n">TabularGANModule</span><span class="p">(</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
            <span class="n">noise_size</span><span class="o">=</span><span class="n">noise_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">gan_loss</span> <span class="o">=</span> <span class="n">GANLoss</span><span class="p">(</span><span class="n">gan_model</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">)</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">GANTrainer</span><span class="p">(</span><span class="n">n_gen</span><span class="p">,</span> <span class="n">n_crit</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
        <span class="n">cbs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">cbs</span><span class="p">)</span> <span class="o">+</span> <span class="n">L</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">GANLearner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">dls</span><span class="p">,</span>
            <span class="n">gan_model</span><span class="p">,</span>
            <span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span>
            <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">opt_func</span><span class="o">=</span><span class="n">opt_func</span><span class="p">,</span>
            <span class="n">loss_func</span><span class="o">=</span><span class="n">gan_loss</span><span class="p">,</span>
        <span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-2</span>

<span class="c1"># Beta1 hyperparam for Adam optimizers</span>
<span class="n">beta1</span> <span class="o">=</span> <span class="mf">0.5</span>



<span class="c1"># learner = GANLearner(dls, generator=generator_model, </span>
<span class="c1">#                      critic=critic_model, </span>
<span class="c1"># #                      opt_func=partial(RMSProp, mom=0.5, sqr_mom=0.99),)</span>
<span class="c1">#                     opt_func=partial(Adam, lr=lr),)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># def data_to_plot(dls, learner):</span>

<span class="c1">#     # dls.cuda()</span>
<span class="c1">#     learner.model.cuda()</span>
<span class="c1">#     real_cat_data = dls.train_ds.cats</span>
<span class="c1">#     real_cont_data = dls.train_ds.conts</span>
<span class="c1">#     fake_data = to_np(learner.model.generate_samples(real_cat_data, real_cont_data))</span>
<span class="c1">#     # fake_data = (</span>
<span class="c1">#     #         learner.model.generate_samples(real_cat_data, real_cont_data).detach().cpu().numpy()</span>
<span class="c1">#     # )</span>
<span class="c1">#     real_data = real_cont_data.to_numpy()</span>
<span class="c1">#     return real_data, fake_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># for i in range(real.shape[1]):</span>
    
<span class="c1">#     plt.hist(fake[:,i], label=&quot;fake&quot;)</span>
<span class="c1">#     plt.hist(real[:,i], label=&quot;real&quot;)</span>
    
<span class="c1">#     plt.title(dls.train_ds.cont_names[i])</span>
<span class="c1">#     plt.legend()</span>
<span class="c1">#     plt.show()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;n_samples&#39;: 100000,
 &#39;batch_size&#39;: 1024,
 &#39;n_noise_samples&#39;: 100,
 &#39;lr&#39;: 1e-05,
 &#39;epochs&#39;: 100,
 &#39;structure&#39;: [2048, 1024, 512, 256, 128, 64],
 &#39;n_features&#39;: 8}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#             generator=generator_model,</span>
<span class="c1">#             critic=critic_model,</span>
<span class="c1">#             noise_size=config[&quot;n_noise_samples&quot;],</span>
<span class="c1">#         )</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#             ann_structure=[config[&quot;n_features&quot;], 100, 50, 1],</span>
<span class="c1">#             act_cls=nn.LeakyReLU(),</span>
<span class="c1">#             final_activation=Sigmoid,</span>
<span class="c1">#             bn_cont=False</span>
<span class="c1">#         )</span>

<span class="c1"># generator = MultiLayerPerceptron(</span>
<span class="c1">#     [config[&quot;n_noise_samples&quot;], 400, 200, 100, 50, config[&quot;n_features&quot;]],</span>
<span class="c1">#     act_cls=nn.LeakyReLU(),</span>
<span class="c1"># #     final_activation=Sigmoid,</span>
<span class="c1">#     bn_cont=False</span>
<span class="c1"># )</span>

<span class="c1"># import torch.optim as optim# Initialize BCELoss function</span>
<span class="c1"># criterion = nn.BCELoss()</span>

<span class="c1"># # Create batch of latent vectors that we will use to visualize</span>
<span class="c1"># #  the progression of the generator</span>
<span class="c1"># # fixed_noise = torch.randn(64, nz, 1, 1, device=device)</span>

<span class="c1"># # Establish convention for real and fake labels during training</span>
<span class="c1"># real_label = 1.</span>
<span class="c1"># fake_label = 0.</span>

<span class="c1"># # Setup Adam optimizers for both G and D</span>
<span class="c1"># optimizerD = optim.Adam(generator.parameters(), lr=lr, betas=(beta1, 0.999))</span>
<span class="c1"># optimizerG = optim.Adam(critic.parameters(), lr=lr, betas=(beta1, 0.999))</span>


<span class="c1"># critic.zero_grad()</span>
<span class="c1"># batch_size = x.shape[0]</span>
<span class="c1"># label = torch.full((batch_size,), real_label, dtype=torch.float)</span>
<span class="c1"># output = critic(cat, y).view(-1)</span>

<span class="c1"># errD_real = criterion(output, label)</span>
<span class="c1"># errD_real.backward()</span>

<span class="c1"># D_x = output.mean().item()</span>

<span class="c1"># # fake = gan_model.generate_samples(cat,x, &quot;cpu&quot;)</span>
<span class="c1"># bs = x.shape[0]</span>
<span class="c1"># noise = gan_model._input_noise(bs).to(&quot;cpu&quot;)</span>
<span class="c1"># fake = generator(cat, noise)</span>
<span class="c1"># # # noise</span>
<span class="c1"># label.fill_(fake_label)</span>
<span class="c1"># output = critic(cat, fake.detach()).view(-1)</span>
<span class="c1"># errD_fake = criterion(output, label)</span>
<span class="c1"># errD_fake.backward()</span>
<span class="c1"># D_G_z1 = output.mean().item()</span>
<span class="c1"># errD = errD_real + errD_fake</span>

<span class="c1"># optimizerD.step()</span>
<span class="c1"># critic.zero_grad()</span>

<span class="c1"># generator.zero_grad()</span>
<span class="c1"># label.fill_(real_label)</span>
<span class="c1"># fake = generator(cat, noise)</span>
<span class="c1"># ouput = critic(cat, fake).view(-1)</span>
<span class="c1"># errG = criterion(output,label)</span>
<span class="c1"># errG.backward()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-26-0be79e0a67f5&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     41</span> <span class="ansi-red-fg"># fake = gan_model.generate_samples(cat,x, &#34;cpu&#34;)</span>
<span class="ansi-green-intense-fg ansi-bold">     42</span> bs <span class="ansi-blue-fg">=</span> x<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">---&gt; 43</span><span class="ansi-red-fg"> </span>noise <span class="ansi-blue-fg">=</span> gan_model<span class="ansi-blue-fg">.</span>_input_noise<span class="ansi-blue-fg">(</span>bs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;cpu&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     44</span> fake <span class="ansi-blue-fg">=</span> generator<span class="ansi-blue-fg">(</span>cat<span class="ansi-blue-fg">,</span> noise<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     45</span> <span class="ansi-red-fg"># # noise</span>

<span class="ansi-red-fg">NameError</span>: name &#39;gan_model&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         dls,</span>
<span class="c1">#         generator,</span>
<span class="c1">#         critic,</span>
<span class="c1">#         criterion=nn.BCELoss(),</span>
<span class="c1">#         lr=1e-3,</span>
<span class="c1">#         noise_size=100,</span>
<span class="c1">#         cbs=[CSVLogger()],</span>
<span class="c1">#         metrics=[RealLossMetric, FakeLossMetric],</span>
<span class="c1">#         opt_func=None,</span>
<span class="c1">#         clip=0.01,</span>
<span class="c1">#         n_gen=1,</span>
<span class="c1">#         n_crit=5,</span>
<span class="c1">#     ):</span>
<span class="c1">#         gan_model = TabularGANModule(</span>
<span class="c1">#             generator=generator,</span>
<span class="c1">#             critic=critic,</span>
<span class="c1">#             noise_size=noise_size,</span>
<span class="c1">#         )</span>

<span class="c1">#         gan_loss = GANLoss(gan_model, criterion=criterion)</span>
<span class="c1"># #         trainer = GANTrainer(n_gen, n_crit, clip)</span>
<span class="c1"># #         cbs = L(cbs) + L(trainer)</span>
<span class="c1"># #         metrics = L(metrics)</span>
        
<span class="c1">#         # Setup Adam optimizers for both G and D</span>
<span class="c1">#         self.optimizerD = optim.Adam(netD.parameters(), lr=lr, betas=(beta1, 0.999))</span>
<span class="c1">#         self.optimizerG = optim.Adam(netG.parameters(), lr=lr, betas=(beta1, 0.999))</span>

        
<span class="c1">#         super(GANLearner, self).__init__(</span>
<span class="c1">#             dls,</span>
<span class="c1">#             gan_model,</span>
<span class="c1">#             cbs=cbs,</span>
<span class="c1">#             lr=lr,</span>
<span class="c1">#             metrics=metrics,</span>
<span class="c1">#             opt_func=opt_func,</span>
<span class="c1">#             loss_func=gan_loss,</span>
<span class="c1">#         )</span>
        
<span class="c1">#     def _do_one_batch(self):</span>
<span class="c1">#         self.pred = self.model(*self.xb)</span>
<span class="c1">#         self(&#39;after_pred&#39;)</span>
<span class="c1">#         if len(self.yb):</span>
<span class="c1">#             self.loss_grad = self.loss_func(self.pred, *self.yb)</span>
<span class="c1">#             self.loss = self.loss_grad.clone()</span>
<span class="c1">#         self(&#39;after_loss&#39;)</span>
<span class="c1">#         if not self.training or not len(self.yb): return</span>
<span class="c1">#         self(&#39;before_backward&#39;)</span>
<span class="c1">#         self.loss_grad.backward()</span>
<span class="c1">#         self._with_events(self.opt.step, &#39;step&#39;, CancelStepException)</span>
<span class="c1">#         self.opt.zero_grad()</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

