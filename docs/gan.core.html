---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/09_gan.core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/09_gan.core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">RMSProp</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.model</span> <span class="kn">import</span> <span class="n">TabularModel</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># from data.synthetic_wind_data import get_synthetic_wind_data</span>
<span class="c1"># from utils_plots import data_to_plot, plot_hists, wind_vs_power</span>
<span class="kn">from</span> <span class="nn">fastai.callback.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># from gan import GANLearner</span>
<span class="kn">from</span> <span class="nn">fastai.vision.gan</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">rng_seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="n">TabularDataLoaders</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="n">TabularProc</span><span class="p">,</span> <span class="n">Tabular</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NormalizePerTask</span><span class="p">(</span><span class="n">TabularProc</span><span class="p">):</span>
    <span class="s2">&quot;Normalize per TaskId&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols_to_ignore</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="n">cols_to_ignore</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">Tabular</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to</span><span class="o">.</span><span class="n">cont_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols_to_ignore</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">to</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">to</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-7</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span>

    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_cols</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>

        
<span class="k">def</span> <span class="nf">get_synthetic_wind_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;powerdata&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">drop_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestFlag&quot;</span><span class="p">]</span>
    <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_list</span><span class="p">]</span>
    <span class="c1"># cont_names = [</span>
    <span class="c1">#     &quot;WindSpeed58m&quot;,</span>
    <span class="c1">#     &quot;WindSpeed60m&quot;,</span>
    <span class="c1">#     &quot;PowerGeneration&quot;,</span>
    <span class="c1"># ]</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;T_HAG_2_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RELHUM_HAG_2_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ASWDIFDS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ASWDIRS_SFC_0_M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WindSpeed58m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WindSpeed60m&quot;</span><span class="p">,</span>
<span class="c1">#         &quot;PowerGeneration&quot;,</span>
    <span class="p">]</span>
    <span class="n">y_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PowerGeneration&quot;</span><span class="p">]</span>
    <span class="c1"># y_names = []</span>

    <span class="n">all_names</span> <span class="o">=</span> <span class="n">cont_names</span> <span class="o">+</span> <span class="n">y_names</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span>
        <span class="n">cont_names</span><span class="o">=</span><span class="n">all_names</span><span class="p">,</span>
        <span class="n">y_names</span><span class="o">=</span><span class="n">all_names</span><span class="p">,</span>
        <span class="c1"># procs=[Normalize],</span>
        <span class="n">bs</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
        <span class="n">procs</span><span class="o">=</span><span class="p">[</span><span class="n">NormalizePerTask</span><span class="p">(</span><span class="n">cols_to_ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PowerGeneration&quot;</span><span class="p">])],</span>
<span class="c1">#         procs=[NormalizePerTask()],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">dls</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># file_name = [&quot;00011.h5&quot;,&quot;01303.h5&quot;,&quot;02559.h5&quot;]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="c1"># &quot;n_features&quot;: 24,</span>
<span class="c1">#     &quot;n_targets&quot;: 1,</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">&quot;n_noise_samples&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="mf">1e-5</span><span class="p">,</span>
    <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span> <span class="o">**</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># config[&quot;n_features&quot;] = len(dls.cont_names)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([1024, 8])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.core</span> <span class="kn">import</span> <span class="n">Callback</span><span class="p">,</span> <span class="n">TrainEvalCallback</span>
<span class="kn">from</span> <span class="nn">fastai.callback.progress</span> <span class="kn">import</span> <span class="n">CSVLogger</span>
<span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span><span class="p">,</span> <span class="n">Metric</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">class2attr</span>
<span class="kn">from</span> <span class="nn">fastcore.foundation</span> <span class="kn">import</span> <span class="n">L</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">fastrenewables.tabular.model</span> <span class="kn">import</span> <span class="n">MultiLayerPerceptron</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Tanh</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Sigmoid</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TrainMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">DISC_REAL</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">DISC_FAKE</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">GEN</span><span class="o">=</span><span class="mi">2</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;TrainMode.DISC_REAL: 0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TabularGANModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">critic</span><span class="p">,</span> <span class="n">noise_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TabularGANModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">critic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_size</span> <span class="o">=</span> <span class="n">noise_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_mode</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># for forward-fct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># for optimizer handling</span>

    <span class="k">def</span> <span class="nf">_input_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="p">):</span>
        <span class="c1"># generate random values, used as input for generator</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_size</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">x_cont</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_noise</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">gen_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gen_data</span>

    <span class="k">def</span> <span class="nf">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">freeze</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="n">freeze</span>
            
    <span class="k">def</span> <span class="nf">update_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="n">train_mode</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
        <span class="c1"># TODO: should not be in the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">,</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requires_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="c1"># take real data</span>
            <span class="n">crit_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">,</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">):</span>
            <span class="c1"># take synthetic data</span>
            <span class="n">gen_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">)</span>
            <span class="n">crit_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">x_cat</span><span class="p">,</span> <span class="n">gen_data</span><span class="p">)</span>
            
<span class="c1">#         print(&quot;crit_out&quot;, crit_out.shape, crit_out[0,0])</span>

        <span class="k">return</span> <span class="n">crit_out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RealLossMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_loss</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">real_loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">real_loss</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class2attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Metric&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FakeLossMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_loss</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">fake_loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_loss</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class2attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Metric&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">GANLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GANLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_label</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train_mode</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># change t w.r.t train_mode</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda:0&quot;</span>
        <span class="n">b_size</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_size</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
<span class="c1">#         print(y.shape, y[0,0])</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
<span class="c1">#         print(t.shape, t[0,0])</span>
<span class="c1">#         print(&quot;*******&quot;)</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b_size</span><span class="p">,</span><span class="n">a_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.core</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">GANTrainer</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">run_after</span> <span class="o">=</span> <span class="n">TrainEvalCallback</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_gen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_crit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GANTrainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gen</span> <span class="o">=</span> <span class="n">n_gen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_crit</span> <span class="o">=</span> <span class="n">n_crit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span>
        

    <span class="k">def</span> <span class="nf">after_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">crit_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="c1">#         self.c_gen = 0</span>
<span class="c1">#         self.c_crit = 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">crit_opt</span>
        <span class="c1"># zero grad only after DISC_FAKE? is done in _do_one_batch anyways</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_value_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_set_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="n">new_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_train_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># TODO: IS THIS DIRECTLY ACCESSING THE MODELS PARAMS?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_FAKE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">fake_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="o">.</span><span class="n">GEN</span> <span class="o">==</span> <span class="n">TrainMode</span><span class="o">.</span><span class="n">GEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_train_mode</span><span class="p">(</span><span class="n">TrainMode</span><span class="o">.</span><span class="n">DISC_REAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">real_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
            


    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">gen_opt</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">GANLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dls</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="n">critic</span><span class="p">,</span>
        <span class="n">criterion</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(),</span>
        <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">noise_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">CSVLogger</span><span class="p">()],</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">RealLossMetric</span><span class="p">,</span> <span class="n">FakeLossMetric</span><span class="p">],</span>
        <span class="n">opt_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">n_gen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_crit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">gan_model</span> <span class="o">=</span> <span class="n">TabularGANModule</span><span class="p">(</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
            <span class="n">noise_size</span><span class="o">=</span><span class="n">noise_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">gan_loss</span> <span class="o">=</span> <span class="n">GANLoss</span><span class="p">(</span><span class="n">gan_model</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">)</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">GANTrainer</span><span class="p">(</span><span class="n">n_gen</span><span class="p">,</span> <span class="n">n_crit</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
        <span class="n">cbs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">cbs</span><span class="p">)</span> <span class="o">+</span> <span class="n">L</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">GANLearner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">dls</span><span class="p">,</span>
            <span class="n">gan_model</span><span class="p">,</span>
            <span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span>
            <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">opt_func</span><span class="o">=</span><span class="n">opt_func</span><span class="p">,</span>
            <span class="n">loss_func</span><span class="o">=</span><span class="n">gan_loss</span><span class="p">,</span>
        <span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-2</span>

<span class="c1"># Beta1 hyperparam for Adam optimizers</span>
<span class="n">beta1</span> <span class="o">=</span> <span class="mf">0.5</span>



<span class="c1"># learner = GANLearner(dls, generator=generator_model, </span>
<span class="c1">#                      critic=critic_model, </span>
<span class="c1"># #                      opt_func=partial(RMSProp, mom=0.5, sqr_mom=0.99),)</span>
<span class="c1">#                     opt_func=partial(Adam, lr=lr),)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># def data_to_plot(dls, learner):</span>

<span class="c1">#     # dls.cuda()</span>
<span class="c1">#     learner.model.cuda()</span>
<span class="c1">#     real_cat_data = dls.train_ds.cats</span>
<span class="c1">#     real_cont_data = dls.train_ds.conts</span>
<span class="c1">#     fake_data = to_np(learner.model.generate_samples(real_cat_data, real_cont_data))</span>
<span class="c1">#     # fake_data = (</span>
<span class="c1">#     #         learner.model.generate_samples(real_cat_data, real_cont_data).detach().cpu().numpy()</span>
<span class="c1">#     # )</span>
<span class="c1">#     real_data = real_cont_data.to_numpy()</span>
<span class="c1">#     return real_data, fake_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># for i in range(real.shape[1]):</span>
    
<span class="c1">#     plt.hist(fake[:,i], label=&quot;fake&quot;)</span>
<span class="c1">#     plt.hist(real[:,i], label=&quot;real&quot;)</span>
    
<span class="c1">#     plt.title(dls.train_ds.cont_names[i])</span>
<span class="c1">#     plt.legend()</span>
<span class="c1">#     plt.show()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;n_samples&#39;: 100000,
 &#39;batch_size&#39;: 1024,
 &#39;n_noise_samples&#39;: 100,
 &#39;lr&#39;: 1e-05,
 &#39;epochs&#39;: 100,
 &#39;structure&#39;: [2048, 1024, 512, 256, 128, 64],
 &#39;n_features&#39;: 8}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#             generator=generator_model,</span>
<span class="c1">#             critic=critic_model,</span>
<span class="c1">#             noise_size=config[&quot;n_noise_samples&quot;],</span>
<span class="c1">#         )</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#             ann_structure=[config[&quot;n_features&quot;], 100, 50, 1],</span>
<span class="c1">#             act_cls=nn.LeakyReLU(),</span>
<span class="c1">#             final_activation=Sigmoid,</span>
<span class="c1">#             bn_cont=False</span>
<span class="c1">#         )</span>

<span class="c1"># generator = MultiLayerPerceptron(</span>
<span class="c1">#     [config[&quot;n_noise_samples&quot;], 400, 200, 100, 50, config[&quot;n_features&quot;]],</span>
<span class="c1">#     act_cls=nn.LeakyReLU(),</span>
<span class="c1"># #     final_activation=Sigmoid,</span>
<span class="c1">#     bn_cont=False</span>
<span class="c1"># )</span>

<span class="c1"># import torch.optim as optim# Initialize BCELoss function</span>
<span class="c1"># criterion = nn.BCELoss()</span>

<span class="c1"># # Create batch of latent vectors that we will use to visualize</span>
<span class="c1"># #  the progression of the generator</span>
<span class="c1"># # fixed_noise = torch.randn(64, nz, 1, 1, device=device)</span>

<span class="c1"># # Establish convention for real and fake labels during training</span>
<span class="c1"># real_label = 1.</span>
<span class="c1"># fake_label = 0.</span>

<span class="c1"># # Setup Adam optimizers for both G and D</span>
<span class="c1"># optimizerD = optim.Adam(generator.parameters(), lr=lr, betas=(beta1, 0.999))</span>
<span class="c1"># optimizerG = optim.Adam(critic.parameters(), lr=lr, betas=(beta1, 0.999))</span>


<span class="c1"># critic.zero_grad()</span>
<span class="c1"># batch_size = x.shape[0]</span>
<span class="c1"># label = torch.full((batch_size,), real_label, dtype=torch.float)</span>
<span class="c1"># output = critic(cat, y).view(-1)</span>

<span class="c1"># errD_real = criterion(output, label)</span>
<span class="c1"># errD_real.backward()</span>

<span class="c1"># D_x = output.mean().item()</span>

<span class="c1"># # fake = gan_model.generate_samples(cat,x, &quot;cpu&quot;)</span>
<span class="c1"># bs = x.shape[0]</span>
<span class="c1"># noise = gan_model._input_noise(bs).to(&quot;cpu&quot;)</span>
<span class="c1"># fake = generator(cat, noise)</span>
<span class="c1"># # # noise</span>
<span class="c1"># label.fill_(fake_label)</span>
<span class="c1"># output = critic(cat, fake.detach()).view(-1)</span>
<span class="c1"># errD_fake = criterion(output, label)</span>
<span class="c1"># errD_fake.backward()</span>
<span class="c1"># D_G_z1 = output.mean().item()</span>
<span class="c1"># errD = errD_real + errD_fake</span>

<span class="c1"># optimizerD.step()</span>
<span class="c1"># critic.zero_grad()</span>

<span class="c1"># generator.zero_grad()</span>
<span class="c1"># label.fill_(real_label)</span>
<span class="c1"># fake = generator(cat, noise)</span>
<span class="c1"># ouput = critic(cat, fake).view(-1)</span>
<span class="c1"># errG = criterion(output,label)</span>
<span class="c1"># errG.backward()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         dls,</span>
<span class="c1">#         generator,</span>
<span class="c1">#         critic,</span>
<span class="c1">#         criterion=nn.BCELoss(),</span>
<span class="c1">#         lr=1e-3,</span>
<span class="c1">#         noise_size=100,</span>
<span class="c1">#         cbs=[CSVLogger()],</span>
<span class="c1">#         metrics=[RealLossMetric, FakeLossMetric],</span>
<span class="c1">#         opt_func=None,</span>
<span class="c1">#         clip=0.01,</span>
<span class="c1">#         n_gen=1,</span>
<span class="c1">#         n_crit=5,</span>
<span class="c1">#     ):</span>
<span class="c1">#         gan_model = TabularGANModule(</span>
<span class="c1">#             generator=generator,</span>
<span class="c1">#             critic=critic,</span>
<span class="c1">#             noise_size=noise_size,</span>
<span class="c1">#         )</span>

<span class="c1">#         gan_loss = GANLoss(gan_model, criterion=criterion)</span>
<span class="c1"># #         trainer = GANTrainer(n_gen, n_crit, clip)</span>
<span class="c1"># #         cbs = L(cbs) + L(trainer)</span>
<span class="c1"># #         metrics = L(metrics)</span>
        
<span class="c1">#         # Setup Adam optimizers for both G and D</span>
<span class="c1">#         self.optimizerD = optim.Adam(netD.parameters(), lr=lr, betas=(beta1, 0.999))</span>
<span class="c1">#         self.optimizerG = optim.Adam(netG.parameters(), lr=lr, betas=(beta1, 0.999))</span>

        
<span class="c1">#         super(GANLearner, self).__init__(</span>
<span class="c1">#             dls,</span>
<span class="c1">#             gan_model,</span>
<span class="c1">#             cbs=cbs,</span>
<span class="c1">#             lr=lr,</span>
<span class="c1">#             metrics=metrics,</span>
<span class="c1">#             opt_func=opt_func,</span>
<span class="c1">#             loss_func=gan_loss,</span>
<span class="c1">#         )</span>
        
<span class="c1">#     def _do_one_batch(self):</span>
<span class="c1">#         self.pred = self.model(*self.xb)</span>
<span class="c1">#         self(&#39;after_pred&#39;)</span>
<span class="c1">#         if len(self.yb):</span>
<span class="c1">#             self.loss_grad = self.loss_func(self.pred, *self.yb)</span>
<span class="c1">#             self.loss = self.loss_grad.clone()</span>
<span class="c1">#         self(&#39;after_loss&#39;)</span>
<span class="c1">#         if not self.training or not len(self.yb): return</span>
<span class="c1">#         self(&#39;before_backward&#39;)</span>
<span class="c1">#         self.loss_grad.backward()</span>
<span class="c1">#         self._with_events(self.opt.step, &#39;step&#39;, CancelStepException)</span>
<span class="c1">#         self.opt.zero_grad()</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

